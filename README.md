# 实验（低七八周）：可靠传输

## 实验要求：

* **Alice要发送多个数据包给Bob，他们之间的通信链路可能<u>丢包</u>或发生<u>比特错误（误码）</u>，假设校验码足够好，所有的比特错误都能被发现**
* **请你设计一套可靠传输协议，实现如下功能：**
  * Alice和Bob可以通过信息推断，各自构造出的数据包集合Pa(t)和Pb(t)
  * Pa(t)和Pb(t)由Alice发送给Bob的数据包组成，且**<u>在任意时刻t，Pa(t) = Pb(t)</u>**
  * Pa(t)和Pb(t)应随着数据包发送过程增长，类似于<u>**Pa(t) = Pb(t) = 空集**</u>这样的脑筋急转弯是不可接受的
  * 这个协议应该尽量告诉，类似于停等协议这样的慢速通信协议是不可接受的
  * 类似于“多个数据包合并为一个大数据包，从而提高速度”这样的脑筋急转弯也是不可接受的
* 通过代码实现设计的程序
* 通过数学分析，分析你们设计的协议在不同丢包率和误码率下的传输性能（注意：丢包和包中有比特错误是不同的，误码率对不同长度数据包的影响也是不同的）
* 通过仿真实验，验证其数学分析
* Deadline：2021年4月26日23：59，以邮箱到达时间为准

## 协议设计

#### 协议概述

分析要求可知，主要设计难点在于：

1. 可靠性
2. 实时同步性
3. 高传输性能

对于**可靠性**的设计主要策略为**确认-重传机制**，即接收方每收到一个数据包都会返回一个ACK包用以确认数据包已经收到，如果ACK包丢失了或者数据包丢失了，则发送方会采用超时重传机制进行重传，从而保证了协议的可靠性。

对于**实时同步性**的设计主要策略为**单个数据包的停等机制**，即发送方发出一个数据包后会等待接收方的对于此数据包ACK来单独追踪发送方与接收方之间的同步状态，在此期间单个数据包的同步是延后于传输的，且在双方确认同步状态之前对于单个数据包的追踪均是停等状态。

对于**高传输性能**的设计主要策略为**流水线机制**，即发送方会连续发多个数据包，接收方会挨个接收并缓存，然后双方均为每个发送/接收的数据包进行同步状态跟踪，保证每个数据包都能在尽可能小的时间间隔内实现状态的一致性同步。

#### 协议细节

因为停等协议是可以满足协议实时同步性的要求的，但是停等协议的缺点在于其传输性能太差了，而为了提高其性能则需要利用流水线机制。

对于传统的停等协议，发送方与接收方的状态同步流程如下：

1. 发送方发送数据包
2. 接收方接收数据包
3. 接收方发送ACK包
4. 发送方收到ACK包，
5. 发送方发送下一个包时上一个包的同步状态递增
6. 接收方收到新的数据包时上一个包的同步状态递增

在上述的流程中，如果出现数据包缺失，可以通过重传来实现，如果出现ACK包丢失，则接收方依旧可以根据发送方的重传信息来确定包的同步状态。

当发送方收到ACK时，发送方知道接收方已经成功收到包了，但是发送方不知道接收方知道发送方知道接收方收到数据包了，即接收方对于自己发送的ACK包是否丢失存疑，此时发送方有足够的证据递增同步状态了，但是接收方不可以，接收方只有收到一个新的数据包时才能确定自己发送的ACK包成功抵达了，此时接收方也有足够的证据递增同步状态了。

分析停等协议之后，可以发现停等协议的同步性是很难以采用流水线机制的，因为停等协议的状态同步依赖于下一个包，也就是不能实现单个包的同步。而采用流水线机制的话，必须要求包和包之间的同步是可以并行的，停等协议显然在这一点上是不可行的。

**所以我们给出了我们自己对于单个包同步的协议，细节如下：**

无丢包时流程如下

1. 发送方发送数据包
2. 接收方收到数据包
3. 接收方发送ACK包
4. 接收方等待一个固定的间隔
5. 发送方收到ACK包
6. 发送方等待一个固定的间隔
7. 接收方递增状态
8. 发送方递增状态

我们的协议的巧妙之处在于，状态同步是延后的，意思是，即使发送方收到了数据包的ACK包，也不会立即递增自己的同步状态，而是等待一个固定的间隔，**这个间隔一般大于两倍的RTT**（只要能在这段时间检测出发送方的超时重传即可），之所以会选择等待，是因为当发送方收到数据包的ACK包时，接收方并不知道此ACK包被发送方成功接收，所以此时双方并不是都对状态同步有足够的信心。而接收方和发送方都等待这样一个时间间隔的原因在于，在此间隔内，如果发送方并没有收到接收方的ACK包，则发送方会触发自身的超时重传机制，即发送方会发送重复的数据包给接收方，接收方收到重复的数据包后就会意识到，上一个ACK包丢失了，然后会重发一个ACK包，然后更新定时器，重新开始等待这一固定间隔。知道双方都等待了这一固定间隔结束，此时接收方有足够的证据证明自己的ACK包已经被发送方收到，而发送方知道只要自己等待这一固定间隔不做事，就能确认接收方知道自己收到ACK的事实，此时发送方和接收方对于状态的同步都是有信心的，所以二者在这一个包上达成共识，进行状态同步。
在实现了单个包的状态同步协议的基础之上，可以对多个包进行同时追踪更新，实现**流水线机制**，以此来提高性能。
